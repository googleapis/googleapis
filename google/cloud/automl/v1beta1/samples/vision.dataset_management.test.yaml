test:
  suites:
  - name: AutoML Vision Classification – Dataset Management
    
    # This includes one test which walks through Create, List, Delete, etc.
    #
    # AutoML Dataset deletion may sometimes take a moment.
    #
    # Optimized down to one test case because:
    # (a) deletion may take a moment
    # (b) 8+ copies of this test are run, one for each AutoML product

    setup:
    # Read project ID from GOOGLE_PROJECT_ID environment variable
    # Note: the location used by all samples it hard-coded to `us-centra1`
    - env: {name: GOOGLE_PROJECT_ID, variable: project_id}
    # Create a unique Dataset display name (max length 32 a-zA-Z0-9_)
    - code: dataset_display_name = "a" + uuid().replace("-", "")[:30]
    - log:
      - "Dataset display_name for test: {}"
      - dataset_display_name

    teardown:
    - log: ["Cleaning up dataset (in case delete step was not run)"]
    - call_may_fail:
        sample: automl_vision_delete_dataset
        params:
          project: { variable: project_id }
          dataset_id: { variable: generated_dataset_id }

    cases:
    - name: Create, List, Get, Update, and Delete
      spec:
      # LIST (assert does not exist)
      - call:
          sample: automl_vision_list_datasets
          params:
            project: { variable: project_id }
      - assert_not_contains:
        - variable: dataset_display_name

      # CREATE
      - call:
          sample: automl_vision_create_dataset
          params:
            project: {variable: project_id}
            display_name: {variable: dataset_display_name}
      # Extract the generated Dataset ID from the Dataset name field (Output only)
      # Format: projects/{project_id}/locations/{location_id}/datasets/{generated_dataset_id}
      - extract_match:
          pattern: datasets/([^\s]+)
          variable: generated_dataset_id
      - log:
        - "Generated Dataset ID: %s"
        - generated_dataset_id
      - assert_contains:
        - literal: "Created dataset"
        - literal: "Name"
        - literal: "Display Name"
        - variable: dataset_display_name
        - literal: "Description"
        # Description is not saving for me on create?
        # Can't seem to get update to work (at all)
        # - literal: "Description of this dataset"
        - literal: "Image classification dataset metadata type: MULTILABEL"

      # LIST (assert does exist)
      - call:
          sample: automl_vision_list_datasets
          params:
            project: {variable: project_id}
      - assert_contains:
        - literal: "Name"
        - variable: generated_dataset_id
        - literal: "Display Name"
        - variable: dataset_display_name
        - literal: "Description"
        - literal: "Image classification dataset metadata type: MULTILABEL"

      # GET
      - call:
          sample: automl_vision_get_dataset
          params:
            project: {variable: project_id}
            dataset_id: {variable: generated_dataset_id}
      - assert_contains:
        - literal: "Name"
        - variable: generated_dataset_id
        - literal: "Display Name"
        - variable: dataset_display_name
        - literal: "Description"
        - literal: "Image classification dataset metadata type: MULTILABEL"
      # Value that Update will change below
      - assert_not_contains:
        - literal: "Updated content of description"

      # DELETE
      - log: ["Deleting dataset (may take a minute)"]
      - call:
          sample: automl_vision_delete_dataset
          params:
            project: {variable: project_id}
            dataset_id: {variable: generated_dataset_id}
      - assert_contains:
        - literal: "Deleted dataset"

      # LIST (assert does not exist)
      - call:
          sample: automl_vision_list_datasets
          params:
            project: { variable: project_id }
      - assert_not_contains:
        - variable: dataset_display_name
        - variable: generated_dataset_id
