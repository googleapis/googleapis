// Copyright 2026 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";

package backstory;

import "google/protobuf/duration.proto";
import "google/protobuf/timestamp.proto";
import "google/type/interval.proto";

option csharp_namespace = "Google.Cloud.Chronicle.Backstory";
option go_package = "google.golang.org/genproto/googleapis/cloud/chronicle/backstory;backstory";
option java_multiple_files = true;
option java_outer_classname = "EntityRiskProto";
option java_package = "com.google.cloud.chronicle.backstory";
option php_namespace = "Google\\Cloud\\Chronicle\\Backstory";
option ruby_package = "Google::Cloud::Chronicle::Backstory";

// This is branched of the original entity.proto in
// googlex/security/malachite/proto/external/entity.proto.
// This is to avoid the circular dependency between udm.proto and
// entity.proto.

// Stores information related to the risk score of an entity.
// Next ID: 15
message EntityRisk {
  // Version of the risk score calculation algorithm.
  string risk_version = 1;

  // Time window used when computing the risk score for an entity, for
  // example 24 hours or 7 days.
  google.type.Interval risk_window = 2;

  // Deprecated risk score.
  int32 DEPRECATED_risk_score = 3
      [deprecated = true, json_name = "DEPRECATEDRiskScore"];

  // Represents the change in risk score for an entity between the end of the
  // previous time window and the end of the current time window.
  optional RiskDelta risk_delta = 4;

  // Number of detections that make up the risk score within the time window.
  int32 detections_count = 5;

  // Timestamp of the first detection within the specified time window.
  // This field is empty when there are no detections.
  google.protobuf.Timestamp first_detection_time = 6;

  // Timestamp of the last detection within the specified time window.
  // This field is empty when there are no detections.
  google.protobuf.Timestamp last_detection_time = 7;

  // Raw risk score for the entity.
  float risk_score = 8;

  // Normalized risk score for the entity. This value is between 0-1000.
  int32 normalized_risk_score = 9;

  // Risk window duration for the entity.
  google.protobuf.Duration risk_window_size = 10;

  // Represents the change in raw risk score for an entity between the end of
  // the previous time window and the end of the current time window.
  optional RiskDelta raw_risk_delta = 11;

  // Timestamp for UEBA risk score reset based deduplication. Used specifically
  // for risk based meta rules.
  google.protobuf.Timestamp last_reset_time = 12;

  // Link to the Google Security Operations UI with information about the entity
  // risk score.
  // If the SecOps instance has multiple frontend paths configured, this will be
  // a relative path that can be used to construct the full URL.
  string detail_uri = 13;

  // Whether there are new detections for the risk window.
  bool risk_window_has_new_detections = 14;
}

// Describes the difference in risk score between two points in time.
message RiskDelta {
  // End time of the previous time window.
  google.protobuf.Timestamp previous_range_end_time = 1;

  // Difference in the normalized risk score from the previous recorded value.
  int32 risk_score_delta = 2;

  // Risk score from previous risk window
  int32 previous_risk_score = 3;

  // Numeric change between current and previous risk score
  int32 risk_score_numeric_delta = 4;
}
